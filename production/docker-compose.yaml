services:
  backend:
    container_name: humanics-backend
    image: ghcr.io/smt197/ressurex-backend-automation:latest
    pull_policy: always
    restart: unless-stopped
    
    # Configuration du réseau
    networks:
      - dockploynetwoork

    # Persistance des fichiers
    volumes:
      - storage_data:/var/www/html/storage
      # - ./:/var/www/html # Décommenter uniquement en développement local

    # Variables d'environnement
    environment:
      # --- APPLICATION ---
      APP_NAME: '${APP_NAME:-humanics}'
      APP_ENV: '${APP_ENV:-production}'
      APP_DEBUG: '${APP_DEBUG:-false}'
      APP_KEY: '${APP_KEY}'
      APP_URL: '${APP_URL}'
      APP_URL_FRONTEND: '${APP_URL_FRONTEND}'
      APP_URL_API: '${APP_URL_API}'
      APP_LOGO: '${APP_LOGO:-logo.png}'

      # --- PHP & PERFORMANCE ---
      # Forcé à 0 comme demandé pour la validation immédiate
      PHP_OPCACHE_ENABLE: '0'
      PHP_OPCACHE_VALIDATE_TIMESTAMPS: '1'
      PHP_OPCACHE_REVALIDATE_FREQ: '0'
      
      PHP_FPM_POOL_NAME: '${PHP_FPM_POOL_NAME:-backend}'
      PHP_FPM_USER: '${PHP_FPM_USER:-www-data}'
      PHP_FPM_GROUP: '${PHP_FPM_GROUP:-www-data}'
      PHP_POOL_NAME: '${PHP_POOL_NAME:-humanics}'
      PHP_FPM_LISTEN: '${PHP_FPM_LISTEN:-0.0.0.0:9000}'

      # --- DATABASE ---
      DB_CONNECTION: mysql
      DB_HOST: '${DB_HOST}'
      DB_PORT: '${DB_PORT:-3306}'
      DB_DATABASE: '${DB_DATABASE}'
      DB_USERNAME: '${DB_USERNAME}'
      DB_PASSWORD: '${DB_PASSWORD}'

      # --- REDIS & CACHE ---
      CACHE_DRIVER: redis
      SESSION_DRIVER: redis
      SESSION_STORE: redis
      QUEUE_CONNECTION: redis
      REDIS_CLIENT: '${REDIS_CLIENT:-predis}'
      REDIS_HOST: '${REDIS_HOST}'
      REDIS_PASSWORD: '${REDIS_PASSWORD}'
      REDIS_PORT: '${REDIS_PORT:-6379}'
      MEMCACHED_HOST: '${MEMCACHED_HOST:-127.0.0.1}'

      # --- MAIL ---
      MAIL_MAILER: smtp
      MAIL_HOST: '${MAIL_HOST}'
      MAIL_PORT: '${MAIL_PORT:-587}'
      MAIL_USERNAME: '${MAIL_USERNAME}'
      MAIL_PASSWORD: '${MAIL_PASSWORD}'
      MAIL_ENCRYPTION: '${MAIL_ENCRYPTION:-null}'
      MAIL_FROM_ADDRESS: '${MAIL_FROM_ADDRESS}'
      MAIL_FROM_NAME: '${MAIL_FROM_NAME:-humanics}'


      # --- SECURITY & SESSION ---
      SANCTUM_STATEFUL_DOMAINS: '${SANCTUM_STATEFUL_DOMAINS}'
      SESSION_DOMAIN: '${SESSION_DOMAIN}'
      SESSION_SECURE_COOKIE: '${SESSION_SECURE_COOKIE:-true}'
      SSL_MODE: '${SSL_MODE:-mixed}'

      # --- BROADCASTING (Pusher) ---
      BROADCAST_DRIVER: pusher
      BROADCAST_CONNECTION: pusher
      PUSHER_APP_ID: '${PUSHER_APP_ID}'
      PUSHER_APP_KEY: '${PUSHER_APP_KEY}'
      PUSHER_APP_SECRET: '${PUSHER_APP_SECRET}'
      PUSHER_HOST: '${PUSHER_HOST}'
      PUSHER_PORT: '${PUSHER_PORT:-443}'
      PUSHER_SCHEME: '${PUSHER_SCHEME:-https}'
      PUSHER_APP_CLUSTER: '${PUSHER_APP_CLUSTER:-mt1}'

      # --- VITE ---
      VITE_APP_NAME: '${APP_NAME}'
      VITE_PUSHER_APP_KEY: '${PUSHER_APP_KEY}'
      VITE_PUSHER_HOST: '${PUSHER_HOST}'
      VITE_PUSHER_PORT: '${PUSHER_PORT:-443}'
      VITE_PUSHER_SCHEME: '${PUSHER_SCHEME:-https}'
      VITE_PUSHER_APP_CLUSTER: '${PUSHER_APP_CLUSTER:-mt1}'

      # --- SYSTEM, LOGS & CONFIG ---
      FILESYSTEM_DISK: '${FILESYSTEM_DISK:-local}'
      LOG_CHANNEL: '${LOG_CHANNEL:-stack}'
      LOG_LEVEL: '${LOG_LEVEL:-debug}'
      LOG_PATH: '${LOG_PATH:-/tmp/laravel.log}'
      LOG_DEPRECATIONS_CHANNEL: '${LOG_DEPRECATIONS_CHANNEL:-null}'
      QUEUE_WORKER_LOG_PATH: '${QUEUE_WORKER_LOG_PATH}'
      MEDIA_MAX_FILE_SIZE: '${MEDIA_MAX_FILE_SIZE:-10485760}'
      AUTORUN_ENABLED: 'true'
      AUTORUN_LARAVEL_MIGRATION_TIMEOUT: '30'
      RESET_FLAGS: '${RESET_FLAGS:-false}'

      # --- PERMISSIONS ---
      PERMISSIONS_READ: 'true'
      PERMISSIONS_WRITE: 'true'
      PERMISSIONS_UPLOAD: 'true'
      PERMISSIONS_DELETE: 'true'
      PERMISSIONS_CREATE: 'true'

    # Healthcheck
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  filegator:
    image: filegator/filegator
    container_name: filegator
    restart: unless-stopped
    ports:
      - "8086:8080"
    volumes:
      - storage_data:/var/www/filegator/repository
    environment:
      PERMISSIONS_READ: '${PERMISSIONS_READ:-true}'
      PERMISSIONS_WRITE: '${PERMISSIONS_WRITE:-true}'
      PERMISSIONS_UPLOAD: '${PERMISSIONS_UPLOAD:-true}'
      PERMISSIONS_DELETE: '${PERMISSIONS_DELETE:-true}'
      PERMISSIONS_CREATE: '${PERMISSIONS_CREATE:-true}'
    networks:
      - dockploynetwoork

# Définition du réseau
networks:
  dockploynetwoork:
    name: dockploynetwoork
    # Si vous n'utilisez pas le réseau managé par dockploynetwoork, commentez 'external: true' et 'name: coolify'
    # et décommentez 'driver: bridge' ci-dessous :
    driver: bridge

# Définition des volumes
volumes:
  storage_data: